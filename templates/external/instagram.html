{% extends "includes/dashboard-base.html" %}
{% load static %}

{% block content %}
 <!-- Load d3-cloud -->
<script src="{% static 'common/d3.min.js' %}"></script>
<script src="{% static 'common/cloud.js' %}"></script>
<script src="{% static 'common/ldavis.js' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://d3js.org/d3.v4.js"></script>

<div class="air__layout__content">
  <div class="air__utils__content">
    <div class="air__utils__heading">
      <h5>Dashboard Instagram</h5>
    </div>
    <div class="card">
      <div class="card-body">
         <h4 class="mb-4">
          <strong>Positive and Negative Words</strong>
        </h4>
        <div class="row">
          <div class="col-lg-6">
            <canvas id="ldapositive"></canvas>
            <p style="text-align: center;">Positive</p>
          </div>
          <div class="col-lg-6">
            <canvas id="ldanegative"></canvas>
            <p style="text-align: center;">Negative</p>
          </div>
        </div>
      </div>
    </div>
    <script>
      function visualize_lda(element_id,file, posneg){
        var data_lda = []  
        $("#"+element_id).ready(function(){
          $.get(file, function(data){
            data_lda_pos = data.split("\n")
            lda_pos_counts = data_lda_pos[0].replace("\r","").split(",")
            lda_pos_words = data_lda_pos[1].replace("\r","").split(",")
            data_lda.push(lda_pos_words)
            data_lda.push(lda_pos_counts)
            const dataLDA = {
              labels: data_lda[0],
              datasets: [{
                label : "Most 10 common "+posneg+" words",
                data: data_lda[1],
                backgroundColor: [
                'rgb(255, 99, 132)',
                'rgb(255, 159, 64)',
                'rgb(255, 205, 86)',
                'rgb(75, 192, 192)',
                'rgb(54, 162, 235)',
                'rgb(153, 102, 255)',
                'rgb(201, 203, 207)',
                'rgb(255, 99, 132)',
                'rgb(255, 159, 64)',
                'rgb(255, 205, 86)',
                ],
                borderWidth: 1
              }]
            };
            const config = {
              type: 'bar',
              data: dataLDA,
              options: {
                scales: {
                  y: {
                    beginAtZero: true
                  }
                }
              },
            };
            const ldaChart = new Chart(
              document.getElementById(element_id),
              config
              );
              
            });
          });
      }
      var element_lda_positive = "ldapositive"
      var element_lda_negative = "ldanegative"
      var data_tw4_positive = "/static/data/json/instagram/instagram_lda_positive-2021-4.csv"
      var data_tw4_negative = "/static/data/json/instagram/instagram_lda_negative-2021-4.csv"
       
      visualize_lda(element_lda_positive,data_tw4_positive,"positive")
      visualize_lda(element_lda_negative,data_tw4_negative,"negative")
    </script>
    <div class="card">
      <div class="card-body">
         <h4 class="mb-4">
          <strong>Topic Found by LDA </strong>
        </h4>
        <div class="row">
          <div class="col-lg-6">
            <table class="table" id="topicpositive">
              <thead class="text-center">
                <tr>
                  <th>
                    Label
                  </th>
                  <th>
                    Topic Positive
                  </th>
                </tr>
              </thead>
              <tbody id= "topicpst">
              <tbody>
            </table>
          </div>
          <div class="col-lg-6">
            <table class="table" id="topicnegative">
              <thead class="text-center">
                <tr>
                  <th>
                    Label
                  </th>
                  <th>
                    Topic Negative
                  </th>
                </tr>
              </thead>
              <tbody id= "topicngtv">
              <tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    <script>
      function generateTable(table, data, tbody) {
        for(let elm = 0; elm < data.length; elm++){
        
          var y = document.createElement("TR");
          var qw = document.createElement("TD");
          
          var z = document.createElement("TD");
          var j = document.createElement("TH");
          
          qw.innerHTML = elm
          z.innerHTML = data[elm]
          y.appendChild(qw);
          y.appendChild(z);
          tbody.appendChild(y)

          table.appendChild(tbody);
        }
      }

      var found_positive_topic = []
      var found_negative_topic = []
      function table_lda(element_id,file){
        $("#"+element_id).ready(function(){
          $.get(file, function(data){
            var data_topic = []  
            split = data.split("\n")
            for(let j in split){
              data_topic.push(split[j].split(","))
            }
            for(let step = 1; step < data_topic.length-1; step++){
              found_positive_topic.push(data_topic[step][0])
              found_negative_topic.push(data_topic[step][1])
            } 
            console.log("found negative", found_negative_topic)
            let idTable_pst = document.getElementById("topicpositive");
            let idTable_ngtv = document.getElementById("topicnegative");
            let tbody_positive = document.getElementById("topicpst");
            let tbody_negative = document.getElementById("topicngtv");
            
            generateTable(idTable_pst, found_positive_topic, tbody_positive);
            generateTable(idTable_ngtv, found_negative_topic, tbody_negative);
          });
        })
      }
      var file_topic = "/static/data/json/instagram/instagram_topicfound_2021-4.csv"
      table_lda("topicpositive",file_topic)
    </script>
    <!--card baru-->
    <div class="card">
      <div class="card-body">
        <h4 class="mb-4">
          <strong>Sentiment Report</strong>
        </h4>
        <div class="row d-flex">
          <div class="col-6 ">
            <button onclick="update('tw1','update')">TW 1</button>
            <button onclick="update('tw2','update')">TW 2</button>
            <button onclick="update('tw3','update')">TW 3</button>
            <button onclick="update('tw4','update')">TW 4</button>
            <canvas id="sentiment"></canvas>
          </div>
          <div class="col-6">
            <div id="sentiment-barplot" class="mt-5"></div>
          </div>
          
        </div>
      </div>
    </div>
    <script>
      var sentiment = document.getElementById("sentiment")
      var myChart = ""
      var tw_datas = [0,0,[280, 50, 100],[432, 123, 245] ]
      function update(tw,status){
        if(tw == 'tw4'){
          tw_data = tw_datas[3]
        } else if (tw == 'tw3') {
          tw_data = tw_datas[2]
        } else if (tw == 'tw2') {
          tw_data = tw_datas[1]
        } else if (tw == 'tw1') {
          tw_data = tw_datas[0]
        } 

        if(status == 'update'){
          myChart.destroy()
        }

        if(tw_data != 0){
          const data = {
            labels: [
              'Positive',
              'Neutral',
              'Negative'
            ],
            datasets: [{
              label: 'Sentiment Instagram',
              data: tw_data,
              backgroundColor: [
                'rgb(54, 162, 235)',
                'rgb(255, 205, 86)',
                'rgb(255, 99, 132)',
              ],
              hoverOffset: 4
            }]
          };
          var config = {
            type: 'pie',
            data: data,
            options: {
              plugins: {
                  legend: {
                    position: 'right',
                  }
              }
            }
          };
          myChart = new Chart(
            sentiment,
            config
            );
        } else{
          sentiment.innerHTML = "<h1> Data Not Found </h1>";
        }
      }
      update('tw4','')
    </script> 
    <script>

      // set the dimensions and margins of the graph
      var margin = {top: 10, right: 30, bottom: 20, left: 50},
          width = 460 - margin.left - margin.right,
          height = 400 - margin.top - margin.bottom;
      
      // append the svg object to the body of the page
      var svg = d3.select("#sentiment-barplot")
        .append("svg")
          .attr("width", width + margin.left + margin.right)
          .attr("height", height + margin.top + margin.bottom)
        .append("g")
          .attr("transform",
                "translate(" + margin.left + "," + margin.top + ")");
      
      // Parse the Data
      d3.csv("https://raw.githubusercontent.com/henritantyoko22/react-native-render-html/master/data_sentiment_2021.csv", function(data) {
      
        // List of subgroups = header of the csv files = soil condition here
        var subgroups = data.columns.slice(1)
      
        // List of groups = species here = value of the first column called group -> I show them on the X axis
        var groups = d3.map(data, function(d){return(d.group)}).keys()
      
        // Add X axis
        var x = d3.scaleBand()
            .domain(groups)
            .range([0, width])
            .padding([0.2])
        svg.append("g")
          .attr("transform", "translate(0," + height + ")")
          .call(d3.axisBottom(x).tickSize(0));
      
        // Add Y axis
        var y = d3.scaleLinear()
          .domain([0, 500])
          .range([ height, 0 ]);
        svg.append("g")
          .call(d3.axisLeft(y));
      
        // Another scale for subgroup position?
        var xSubgroup = d3.scaleBand()
          .domain(subgroups)
          .range([0, x.bandwidth()])
          .padding([0.05])
      
        // color palette = one color per subgroup
        var color = d3.scaleOrdinal()
          .domain(subgroups)
          .range([
          'rgb(54, 162, 235)',
          'rgb(255, 205, 86)',
          'rgb(255, 99, 132)'
          ])
      
        // Show the bars
        svg.append("g")
          .selectAll("g")
          // Enter in data = loop group per group
          .data(data)
          .enter()
          .append("g")
            .attr("transform", function(d) { return "translate(" + x(d.group) + ",0)"; })
          .selectAll("rect")
          .data(function(d) { return subgroups.map(function(key) { return {key: key, value: d[key]}; }); })
          .enter().append("rect")
            .attr("x", function(d) { return xSubgroup(d.key); })
            .attr("y", function(d) { return y(d.value); })
            .attr("width", xSubgroup.bandwidth())
            .attr("height", function(d) { return height - y(d.value); })
            .attr("fill", function(d) { return color(d.key); });
      
      })
      
    </script>
    <!--tabel-->
    <div class="card">
      <div class="card-body">
        <div class="row">
          <div class="col-lg-12">
            <div class="mb-5">
              <table class="table table-hover nowrap" id="instagram_table">
                <thead>
                  <tr>
                    <th>Username : </th>
                    <th>UserLink : </th>
                    <th>Post Time : </th>
                    <th>Post Like(s) : </th>
                    <th>Description : </th>
                    <th>Comment Username : </th>
                    <th>Comment UserLink : </th>
                    <th>Comment Text : </th>
                    <th>Comment Like(s) : </th>
                    <th>Comment Time : </th>
                    <th>Comment Reply : </th> 
                  </tr>
                </thead>
                <tbody>  
                  {% for ig in data %}
                  <tr>
                    <td>{{ ig.post_username }}</td>
                    <td>{{ ig.post_userlink }}</td>
                    <td>{{ ig.post_time }}</td>
                    <td>{{ ig.post_like }}</td>
                    <td>{{ ig.post_description }}</td>
                    <td>{{ ig.comment_user }}</td>
                    <td> <a href="{{ ig.comment_userlink }}">{{ ig.comment_userlink }}</a></td>
                    <td>{{ ig.comment_txt }}</td>
                    <td>{{ ig.comment_like }}</td>
                    <td>{{ ig.comment_time }}</td>
                    <td>
                      {% if ig.reply != 0 %}
                        <br> 
                        <p style="white-space: pre; margin: -15px -15px">
                          {
                              time reply : {{ ig.reply.scrapper_time_reply }}
                              username reply: {{ ig.reply.username_reply}},
                              href reply: <a href="{{ ig.reply.username_reply_link }}">{{ ig.reply.username_reply_link }}</a>, 
                              comment reply : {{ ig.reply.username_reply_text }},
                              like reply : {{ ig.reply.like_comment_reply }}, 
                          }
                        </p>
                        <br>
                      {% else %}
                        0
                      {% endif %}
                    </td>                  
                  </tr>
                  {% endfor %}
                </tbody>  
              </table>
            </div>
          </div>
        </div>  
      </div>
    </div>
    <script type="text/javascript">
    $(function () {
          $("#instagram_table").DataTable({
            responsive: true,
          });
        });
      (jQuery);  
    </script>
</div>
{% endblock content %}